<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Autoritratto 2D</title>
  <style>
    body{ margin:0; background:#1f1f1f; height:100vh; display:grid; place-items:center; }
    canvas{ display:block; }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/p5@1.11.11/lib/p5.min.js"></script>
<script>
let img;
let dots = [];

// ---------- DETTAGLIO / SPAZIATURA ----------
const RESIZE_DIV = 6.0;    // risoluzione complessiva dell'immagine (prova 4.8..6.2)
const SAMPLE = 2;          // 2 = ogni 2px (meno denso), 3 = ancora più rado
const SPACING = 9;         // spaziatura della griglia visiva (più alto = più spazio per muoversi)

// ---------- ASPETTO DEI PUNTI ----------
const MIN_DOT = 0.8;
const MAX_DOT = 6.5;
const GAMMA = 0.60;        // enfasi dei mezzitoni (più piccolo = mezzitoni più luminosi)
const IMAGE_EDGE_FADE = 55;

// ---------- MOVIMENTO ----------
const SPRING = 0.035;      // più basso = più deformazione (ma può diventare caotico)
const DAMPING = 0.86;      // più basso = effetto più viscoso
const MAG_RADIUS = 220;    // campo più ampio = deformazione più morbida
const MAG_FORCE  = 2.7;    // attrazione più forte = movimento più evidente
const FLOW = 0.45;         // lieve vortice per una sensazione “liquida”

function preload(){ img = loadImage("gr.png"); }

function setup(){
  createCanvas(1200,900);
  pixelDensity(1);

  img.resize(floor(img.width / RESIZE_DIV), 0);
  img.loadPixels();

  buildDots();
}

function buildDots(){
  dots = [];
  const w = img.width, h = img.height;

  const cols = floor((w - 1) / SAMPLE) + 1;
  const rows = floor((h - 1) / SAMPLE) + 1;
  const renderW = (cols - 1) * SPACING;
  const renderH = (rows - 1) * SPACING;
  const ox = (width  - renderW) / 2;
  const oy = (height - renderH) / 2;

  let jj = 0;
  for (let y = 0; y < h; y += SAMPLE){
    let ii = 0;
    for (let x = 0; x < w; x += SAMPLE){
      const idx = 4 * (y * w + x);
      const r = img.pixels[idx];
      const g = img.pixels[idx + 1];
      const b = img.pixels[idx + 2];
      const a = img.pixels[idx + 3];
      if (a < 5) { ii++; continue; }

      const gray = 0.2126*r + 0.7152*g + 0.0722*b;

      const g01 = pow(constrain(gray / 255, 0, 1), GAMMA);
      const d0 = lerp(MIN_DOT, MAX_DOT, g01);

      const hx = ox + ii * SPACING;
      const hy = oy + jj * SPACING;

      const edgeDist = Math.min(x, w - 1 - x, y, h - 1 - y);
      const edgeFade = constrain(map(edgeDist, 0, IMAGE_EDGE_FADE, 0, 1), 0, 1);

      dots.push({ hx, hy, x:hx, y:hy, vx:0, vy:0, gray, d0, edgeFade });
      ii++;
    }
    jj++;
  }
}

function draw(){
  background(0);
  noStroke();

  const mx = mouseX, my = mouseY;
  const mouseInside = (mx >= 0 && mx <= width && my >= 0 && my <= height);

  for (const p of dots){
    // molla verso la posizione originale
    let ax = (p.hx - p.x) * SPRING;
    let ay = (p.hy - p.y) * SPRING;

    // magnete
    if (mouseInside){
      const dx = mx - p.x, dy = my - p.y;
      const r2 = dx*dx + dy*dy;
      const R = MAG_RADIUS;

      if (r2 < R*R){
        const dist = sqrt(r2) + 1e-6;
        let t = 1 - dist / R;
        t = t * t * (3 - 2 * t); // smoothstep

        const nx = dx / dist, ny = dy / dist;
        const pull = MAG_FORCE * t;

        ax += nx * pull;
        ay += ny * pull;

        // flusso tangenziale
        const tx = -ny, ty = nx;
        const swirl = FLOW * t;
        ax += tx * swirl;
        ay += ty * swirl;
      }
    }

    // integrazione
    p.vx = (p.vx + ax) * DAMPING;
    p.vy = (p.vy + ay) * DAMPING;
    p.x += p.vx;
    p.y += p.vy;

    const speed = sqrt(p.vx*p.vx + p.vy*p.vy);
    const d = p.d0 + speed * 0.22;

    fill(p.gray, 255 * p.edgeFade);
    circle(p.x, p.y, d);
  }
}

// tasti rapidi per la messa a punto
function keyPressed(){
  if (key === '1') { 
    // più flusso / deformazione
    // soluzione rapida: molla più debole, magnete più forte
    // (modifica le costanti in modo permanente se ti piace l'effetto)
  }
  if (key === 'r' || key === 'R') buildDots();
}
</script>
</body>
</html>